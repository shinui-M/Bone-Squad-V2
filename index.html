<!DOCTYPE html>
<html lang="ko">
<head>
<script>
    // =====================================================================
    // â–¼â–¼â–¼ [í•„ìˆ˜] ì—¬ê¸°ì— êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! â–¼â–¼â–¼
    // ë”°ì˜´í‘œ("") ì•ˆì— ì£¼ì†Œê°€ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPzqObrlx0q5kXHHMPAKBTzq9J3XTd5j-LuPkxZKCWhNjiZ4pPEUbYMxFqLQxM3kvXpg/exec"; 
    // =====================================================================
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ˆê°ˆë‹¨ ìŠ¤í„°ë”” í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <style>
        /* ìŠ¤íƒ€ì¼ ì½”ë“œ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; margin: 0; }
        .banner { width: 100%; max-height: 300px; object-fit: cover; border-bottom: 3px solid #e74c3c; }
        .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #eee; }
        
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; flex-wrap: wrap;}
        .tab-link { padding: 15px 10px; cursor: pointer; font-weight: bold; color: #999; transition: 0.3s; flex: 1; text-align: center; min-width: 80px; }
        .tab-link:hover { color: #e74c3c; background: #fff5f5; }
        .tab-link.active { color: #e74c3c; border-bottom: 4px solid #e74c3c; background: #fff; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: #e74c3c; text-align: center; margin-top: 0; }
        .sub-title { color: #666; text-align: center; margin-bottom: 20px; }
        input.name-input { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e74c3c; border-radius: 8px; background: #fff; color: #333; text-align: center; font-size: 1.1em; font-weight:bold; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.3s; }
        .btn-submit:hover { background: #c0392b; }

        .calendar-controls { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; font-size: 1.3em; font-weight: bold; color: #333; }
        .btn-move { background: none; border: none; color: #e74c3c; font-size: 1.5em; cursor: pointer; padding: 0 20px; }
        
        .weekly-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-column { background: #fff; border: 1px solid #eee; border-radius: 8px; min-height: 300px; display: flex; flex-direction: column; }
        .day-column.today { border: 2px solid #e74c3c; background-color: #fff5f5; }
        
        .day-header { padding: 10px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; background: #f9f9f9; border-radius: 8px 8px 0 0; }
        .day-header.sun { color: #e74c3c; } .day-header.sat { color: #3498db; }
        
        .day-body { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; gap: 5px; cursor: pointer; transition: 0.2s; }
        .day-body:hover { background-color: #fafafa; }

        .submitter-card { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 6px; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 5px; }
        .submitter-card.me { border-color: #e74c3c; background: #fff0f0; }
        .mini-avatar { width: 20px; height: 20px; border-radius: 50%; background: #eee; }
        .rating-badge { margin-left: auto; font-weight: bold; color: #f1c40f; font-size: 0.9em; }

        .input-group { margin-bottom: 15px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .type-select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 80px; }
        .content-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-add { background: #34495e; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .btn-remove { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 600px; max-width: 95%; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { color: #e74c3c; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; font-weight: bold; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        
        .detail-card { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #bdc3c7; }
        .detail-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        .detail-item { display: flex; margin-bottom: 5px; font-size: 0.95em; }
        .detail-type { font-weight: bold; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 8px; min-width: 40px; text-align: center; }
        .type-work { background: #3498db; }
        .type-study { background: #e74c3c; }
        .type-rest { background: #2ecc71; }
        .type-etc { background: #95a5a6; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:flex; justify-content:center; align-items:center; flex-direction: column; z-index: 2000; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #e74c3c; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .close-btn { cursor: pointer; font-size: 2em; line-height: 0.5; color: #999; }
        
        .ranking-list, .feed-list, .member-grid { list-style: none; padding: 0; }
        .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .member-card { border: 1px solid #eee; padding: 15px; text-align: center; border-radius: 10px; background: #fff; }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; }
        textarea.feed-input { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box;}
    </style>
</head>
<body>

<img src="banner.jpg" alt="ë¼ˆê°ˆë‹¨ ë°°ë„ˆ" class="banner" onerror="this.style.display='none'">

<div id="loadingMsg" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div style="color:#e74c3c; font-weight:bold; font-size:1.2em;">ğŸ”¥ ë¼ˆê°ˆë‹¨ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div class="container">
    <input type="text" id="userName" class="name-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (í•„ìˆ˜)">

    <div class="tabs">
        <div class="tab-link active" onclick="openTab('calendarTab', event)">ğŸ“… ì£¼ê°„ ì„±ê³¼</div>
        <div class="tab-link" onclick="openTab('rankingTab', event)">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</div>
        <div class="tab-link" onclick="openTab('snsTab', event)">ğŸ’€ ë¼ˆì´ìŠ¤ë¶</div>
        <div class="tab-link" onclick="openTab('memberTab', event)">ğŸ‘¥ ë©¤ë²„ ì†Œê°œ</div>
    </div>

    <div id="calendarTab" class="tab-content active">
        <h2>â˜ ï¸ ì£¼ê°„ ì„±ê³¼ í˜„í™©</h2>
        <div class="sub-title">ì´ë²ˆ ì£¼, ì–¼ë§ˆë‚˜ ë¼ˆë¥¼ ê°ˆì•˜ëŠ”ê°€?</div>
        
        <div class="calendar-controls">
            <button class="btn-move" onclick="changeWeek(-7)">â—€ ì§€ë‚œì£¼</button>
            <span id="currentWeekRange" style="margin: 0 20px;"></span>
            <button class="btn-move" onclick="changeWeek(7)">ë‹¤ìŒì£¼ â–¶</button>
            <button onclick="loadData()" style="font-size:0.8em; cursor:pointer; background:none; border:none; color:#e74c3c;">ğŸ”„</button>
        </div>

        <div class="weekly-grid" id="weeklyCalendar">
            </div>
    </div>

    <div id="rankingTab" class="tab-content">
        <h2>ğŸ† ìµœë‹¤ ë¼ˆê°ˆì´ ë­í‚¹</h2>
        <ul id="rankingList" class="ranking-list"></ul>
    </div>

    <div id="snsTab" class="tab-content">
        <h2>ğŸ’€ ë¼ˆì´ìŠ¤ë¶</h2>
        <div style="margin-bottom:20px;">
            <textarea id="inputFeed" class="feed-input" placeholder="ììœ ë¡­ê²Œ ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..."></textarea>
            <button class="btn-submit" onclick="saveFeed()">ê²Œì‹œí•˜ê¸°</button>
        </div>
        <ul id="feedList" class="feed-list"></ul>
    </div>

    <div id="memberTab" class="tab-content">
        <h2>ğŸ‘¥ ë©¤ë²„ ëª©ë¡</h2>
        <div class="member-grid" id="memberList"></div>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalDateTitle"></span>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <h4 style="color:#e74c3c; margin-top:0;">ğŸ“‹ ì˜¤ëŠ˜ì˜ ë¼ˆê°ˆë‹¨ ê¸°ë¡</h4>
            <div id="othersList"></div>
            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
            <h4 style="color:#e74c3c;">âœï¸ ì„±ê³¼ ì‘ì„±í•˜ê¸°</h4>
            <div class="input-group">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">â­ ì˜¤ëŠ˜ í•˜ë£¨ í‰ì  (0.0 ~ 5.0)</label>
                <input type="number" id="inputRating" step="0.1" min="0" max="5" value="0.0" style="padding:5px; border:1px solid #ddd; border-radius:4px; width:100px;">
            </div>
            <div class="input-group">
                <label style="font-weight:bold; display:block; margin-bottom:10px;">ğŸ“ ìƒì„¸ í•­ëª©</label>
                <div id="taskItemsContainer"></div>
                <button class="btn-add" onclick="addTaskItem()">+ í•­ëª© ì¶”ê°€</button>
            </div>
            <button class="btn-submit" onclick="saveTask()">ì œì¶œí•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
    let dbData = { tasks: [], feeds: [], comments: [], members: [] };
    let selectedDateKey = null;

    window.onload = function() {
        const savedName = localStorage.getItem('study_username');
        if(savedName) document.getElementById('userName').value = savedName;
        addTaskItem(); 
        loadData();
    };

    document.getElementById('userName').addEventListener('input', function() {
        localStorage.setItem('study_username', this.value);
    });

    function renderWeeklyCalendar() {
        const grid = document.getElementById('weeklyCalendar');
        grid.innerHTML = '';
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        document.getElementById('currentWeekRange').innerText = `${currentWeekStart.getMonth()+1}.${currentWeekStart.getDate()} ~ ${weekEnd.getMonth()+1}.${weekEnd.getDate()}`;
        const myName = document.getElementById('userName').value.trim();
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        for (let i = 0; i < 7; i++) {
            const dateObj = new Date(currentWeekStart);
            dateObj.setDate(dateObj.getDate() + i);
            const dateKey = `${dateObj.getFullYear()}-${dateObj.getMonth()+1}-${dateObj.getDate()}`;
            const col = document.createElement('div');
            col.className = 'day-column';
            const todayKey = new Date().getFullYear() + '-' + (new Date().getMonth()+1) + '-' + new Date().getDate();
            if (dateKey === todayKey) col.classList.add('today');

            const header = document.createElement('div');
            header.className = 'day-header';
            if(i===0) header.classList.add('sun');
            if(i===6) header.classList.add('sat');
            header.innerHTML = `${days[i]} <span style="font-size:0.8em; color:#999;">(${dateObj.getDate()}ì¼)</span>`;
            
            const body = document.createElement('div');
            body.className = 'day-body';
            body.onclick = () => openModal(dateKey);

            if (dbData.tasks) {
                const todaysData = dbData.tasks.filter(t => t.date === dateKey);
                todaysData.forEach(item => {
                    let parsed = parseTaskContent(item.task);
                    const card = document.createElement('div');
                    card.className = 'submitter-card';
                    if (myName && item.name === myName) card.classList.add('me');
                    const memberInfo = dbData.members ? dbData.members.find(m => m.name === item.name) : null;
                    const avatarUrl = memberInfo && memberInfo.avatar ? memberInfo.avatar : `https://api.dicebear.com/7.x/notionists/svg?seed=${item.name}`;
                    card.innerHTML = `<img src="${avatarUrl}" class="mini-avatar"><span>${item.name}</span>${parsed.rating ? `<span class="rating-badge">â˜…${parsed.rating}</span>` : ''}`;
                    body.appendChild(card);
                });
            }
            col.appendChild(header); col.appendChild(body); grid.appendChild(col);
        }
    }

    function changeWeek(days) { currentWeekStart.setDate(currentWeekStart.getDate() + days); renderWeeklyCalendar(); }

    function addTaskItem(initialData = null) {
        const container = document.getElementById('taskItemsContainer');
        const div = document.createElement('div');
        div.className = 'input-row';
        div.innerHTML = `<select class="type-select"><option value="ì—…ë¬´">ì—…ë¬´</option><option value="ê³µë¶€">ê³µë¶€</option><option value="íšŒë³µ">íšŒë³µ</option><option value="ê¸°íƒ€">ì§ì ‘</option></select><input type="text" class="content-input" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë‹¨ì–´ 1ì¥ ì•”ê¸°)"><button class="btn-remove" onclick="this.parentElement.remove()">X</button>`;
        container.appendChild(div);
        if(initialData) { div.querySelector('.type-select').value = initialData.category; div.querySelector('.content-input').value = initialData.content; }
    }

    function saveTask() {
        const name = document.getElementById('userName').value.trim();
        const rating = document.getElementById('inputRating').value;
        if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        const items = [];
        document.querySelectorAll('#taskItemsContainer .input-row').forEach(row => {
            const type = row.querySelector('.type-select').value;
            const content = row.querySelector('.content-input').value.trim();
            if(content) items.push({ category: type, content: content });
        });
        if(items.length === 0) { alert("í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        const taskObject = { rating: rating, items: items };
        const taskString = JSON.stringify(taskObject);
        const newData = { action: 'saveTask', date: selectedDateKey, name: name, task: taskString };
        
        dbData.tasks = dbData.tasks.filter(t => !(t.date === selectedDateKey && t.name === name));
        dbData.tasks.push(newData);
        renderWeeklyCalendar(); closeModal();
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(newData) });
    }

    function loadData() {
        const loadingEl = document.getElementById('loadingMsg');
        if(typeof SCRIPT_URL === 'undefined' || SCRIPT_URL.includes("ì—¬ê¸°ì—")) { loadingEl.style.display='none'; alert("ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”!"); return; }
        loadingEl.style.display = 'flex';
        fetch(SCRIPT_URL + "?action=getAllData")
            .then(response => response.json())
            .then(data => {
                dbData = data; renderWeeklyCalendar(); loadingEl.style.display = 'none';
                if(data.members) {
                     const mList = document.getElementById('memberList');
                     mList.innerHTML = '';
                     data.members.forEach(m => {
                         const d = document.createElement('li'); d.className='member-card';
                         d.innerHTML = `<img src="${m.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+m.name}" class="member-avatar"><div style="font-weight:bold;">${m.name}</div><div style="font-size:0.9em; color:#666;">${m.bio}</div>`;
                         mList.appendChild(d);
                     });
                }
            })
            .catch(e => { console.error(e); loadingEl.style.display='none'; });
    }

    function parseTaskContent(taskStr) {
        try { if (taskStr.trim().startsWith("{")) return JSON.parse(taskStr); } catch (e) {}
        return { rating: null, items: [{ category: 'ê¸°ì¡´', content: taskStr }] };
    }

    function openModal(date) {
        selectedDateKey = date;
        document.getElementById('modalDateTitle').innerText = `${date} ê¸°ë¡`;
        document.getElementById('inputRating').value = "0.0";
        document.getElementById('taskItemsContainer').innerHTML = ''; addTaskItem();
        const listEl = document.getElementById('othersList');
        listEl.innerHTML = '';
        const todaysTasks = dbData.tasks ? dbData.tasks.filter(t => t.date === date) : [];
        if(todaysTasks.length === 0) listEl.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ê¸°ë¡ ì—†ìŒ</div>';
        else {
            todaysTasks.forEach(t => {
                const parsed = parseTaskContent(t.task);
                const detailDiv = document.createElement('div');
                detailDiv.className = 'detail-card';
                let itemsHtml = '';
                parsed.items.forEach(item => {
                    let typeClass = item.category === 'ì—…ë¬´' ? 'type-work' : item.category === 'ê³µë¶€' ? 'type-study' : item.category === 'íšŒë³µ' ? 'type-rest' : 'type-etc';
                    itemsHtml += `<div class="detail-item"><span class="detail-type ${typeClass}">${item.category}</span><span>${item.content}</span></div>`;
                });
                detailDiv.innerHTML = `<div class="detail-header"><span>${t.name}</span>${parsed.rating ? `<span style="color:#f1c40f;">â˜… ${parsed.rating}</span>` : ''}</div><div>${itemsHtml}</div>`;
                listEl.appendChild(detailDiv);
            });
        }
        document.getElementById('taskModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('taskModal').style.display = 'none'; }
    function openTab(name, e) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        e.currentTarget.classList.add('active');
        if(name==='calendarTab') renderWeeklyCalendar();
    }
    window.onclick = function(e) { if(e.target == document.getElementById('taskModal')) closeModal(); }
    function saveFeed() {} // í”¼ë“œ ê¸°ëŠ¥ ìƒëµ (ê³µê°„ ì ˆì•½)
</script>
</body>
</html>

